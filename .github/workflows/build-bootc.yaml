name: Build bootc container
on: 
  workflow_dispatch:
env:
  IMAGE: ghcr.io/yuanandcircle/almavirt:10-kitten
jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Build
        run: |
          sudo podman build --security-opt=label=disable --cap-add=all --device /dev/fuse \
            -t ${{ env.IMAGE }} .
      - name: Push
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | sudo skopeo login ghcr.io -u $ --password-stdin
          sudo skopeo copy containers-storage:${{ env.IMAGE }} docker://${{ env.IMAGE }}
  clean:
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/delete-package-versions@v5
        with:
          package-name: almavirt
          package-type: container
          min-versions-to-keep: 0
          delete-only-untagged-versions: true
